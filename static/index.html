<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Mock API Manager</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- DataTables with Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <!-- Custom CSS for styling -->
    <style>
        /* [Include all your existing CSS styles here] */
        /* ... (Omitted for brevity) ... */
        body {
            background-color: #f8f9fa;
            padding-bottom: 80px;
            /* Ensure footer doesn't overlap content */
        }

        h1,
        h2 {
            color: #343a40;
            /* Added for animation */
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInUp 1s forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .table thead th {
            vertical-align: middle;
            text-align: center;
        }

        .table tbody td {
            vertical-align: middle;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 0.5em;
            display: inline-block;
            width: auto;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.5em 1em;
        }

        .dataTables_wrapper .dataTables_info {
            font-size: 0.9em;
        }

        .dataTables_wrapper .dataTables_length select {
            width: auto;
        }

        .json-view {
            font-family: monospace;
            padding: 10px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        /* Collapsible JSON styles */
        .collapsible {
            cursor: pointer;
            font-weight: bold;
        }

        .expanded::before {
            content: "- ";
            color: #007bff;
        }

        .collapsed::before {
            content: "+ ";
            color: #007bff;
        }

        .collapsible-placeholder {
            display: inline;
            color: #777;
        }

        .collapsible-content {
            display: none;
            margin-left: 20px;
        }

        /* JSON syntax highlighting */
        .json-key {
            color: #d9534f;
        }

        .json-string {
            color: #5bc0de;
        }

        .json-number {
            color: #f0ad4e;
        }

        .json-boolean {
            color: #5cb85c;
        }

        .json-null {
            color: #777;
        }

        .json-placeholder {
            color: #ff00ff;
            font-style: italic;
        }

        footer {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.875em;
            color: #555;
            padding: 5px 0;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid #ddd;
        }

        footer a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        footer a:hover {
            text-decoration: underline;
        }

        footer .version-info {
            color: #777;
            margin-top: 5px;
            font-size: 0.85em;
        }

        /* Modal custom styles */
        .modal-content {
            border-radius: 10px;
        }

        .modal-header {
            border-bottom: none;
        }

        .modal-footer {
            border-top: none;
        }

        .modal-body {
            font-size: 1.1em;
        }

        .modal.fade .modal-dialog {
            transform: translateY(-50px);
            transition: transform 0.5s ease-out;
            /* Slowed down animation */
        }

        .modal.show .modal-dialog {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 767.98px) {
            .table-responsive {
                overflow-x: auto;
            }

            .btn {
                margin-bottom: 5px;
            }

            /* Adjust floating menu position on smaller screens */
            .floating-menu {
                top: 10px;
                right: 10px;
                transform-origin: center;
                transition: transform 0.3s ease;
            }
        }

        /* Styles for the collapsible panel */
        .collapsible-panel {
            border: 1px solid #ced4da;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
            /* Ensure consistent spacing */
            background-color: #ffffff;
            /* box-shadow removed for cleaner look */
            transition: box-shadow 0.3s ease;
        }

        .collapsible-panel.expanded {
            margin-top: 0;
            /* Ensures no extra spacing at the top */
            background-color: #ffffff;
            /* Matches the panel's background */
        }

        .collapsible-panel:not(.expanded)+.table-responsive {
            margin-top: 20px;
            /* Adds gap between the collapsed panel and Current Mocks */
        }

        .collapsible-panel-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ced4da;
        }

        .collapsible-panel.expanded:before {
            content: none;
            /* Ensures nothing is displayed */
            display: none;
            /* Ensures no space is occupied */
        }

        .collapsible-panel.expanded .collapsible-panel-header {
            border-bottom: none;
        }

        .collapsible-panel-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .collapsible-panel-header .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.5s;
            /* Slowed down rotation */
        }

        .collapsible-panel-body {
            padding: 15px;
            margin: 0;
            display: none;
            transition: all 0.5s ease;
            /* Slowed down animation */
        }

        .collapsible-panel.expanded .collapsible-panel-body {
            display: block;
            margin-top: 0;
            /* Removes extra margin causing white space */
            padding: 15px;
            /* Ensure content has proper spacing */
        }

        .collapsible-panel.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .text-action {
            /* Changed from span to button for consistency */
            /* Removed for buttons */
        }

        .text-action:hover {
            text-decoration: none;
        }

        /* Styles for Floating Action Menu */
        .floating-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            /* box-shadow removed to eliminate shadow under the circle menu */
            /* box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); */
            transition: transform 0.3s ease;
        }

        .floating-menu .fab {
            width: 60px;
            height: 60px;
            background-color: #007bff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            cursor: pointer;
            /* box-shadow removed for cleaner look */
            /* box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); */
            transition: transform 0.3s ease, background-color 0.3s ease;
            font-size: 24px;
            /* Increased font size for visibility */
            user-select: none;
        }

        .floating-menu .fab:hover {
            background-color: #0056b3;
        }

        /* Removed image inside fab and added "+" symbol */
        /* .floating-menu .fab img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%; /* Keeps the image circular 
        } */

        .floating-menu .action-buttons {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-top: 10px;
        }

        .floating-menu .action-buttons button {
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .floating-menu.open .action-buttons button {
            opacity: 1;
            transform: translateY(0);
        }

        .floating-menu.open {
            transform: scale(1.05);
            /* Slightly enlarge on open for a smoother feel */
            /* box-shadow removed to eliminate shadow under the circle menu */
            /* box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); */
        }

        .floating-menu .action-buttons button:last-child {
            margin-bottom: 0;
        }

        /* Styles for the extra checkbox column */
        .select-checkbox {
            text-align: center;
        }

        .select-checkbox input {
            margin: 0;
        }

        /* Adjust table when checkboxes are shown */
        .table-selectable tbody tr.selected {
            background-color: #d1ecf1;
        }

        /* Notification Styling */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 250px;
        }

        /* Added processing time styling */
        .processing-time {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Button styles for format and toggle */
        .btn-json-action {
            margin-right: 10px;
            /* Adjusted top margin to 5px */
            margin-top: 5px;
        }

        .btn-json-action:last-child {
            margin-right: 0;
        }

        /* Styles for dynamic response blocks */
        .response-block {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f1f1f1;
            position: relative;
        }

        .remove-response-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* Adjusting buttons within response blocks */
        .response-actions {
            margin-top: 10px;
        }

        .response-actions button {
            margin-right: 10px;
        }

        /* Styles for headers and conditions within response blocks */
        .headers-container,
        .conditions-container {
            margin-top: 10px;
        }

        .header-pair,
        .condition-pair {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .header-pair input,
        .condition-pair input {
            margin-right: 10px;
        }

        .remove-header-btn,
        .remove-condition-btn {
            padding: 0 5px;
        }
    </style>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables with Bootstrap 4 JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
</head>

<body class="container my-5">
    <h1 class="text-center mb-4">Mock API Manager</h1>

    <!-- Notification and Loading Indicators -->
    <div id="notification" class="alert text-center" style="display:none;">
        <span id="notification-message">Mock API saved successfully!</span>
        <div class="processing-time" id="processing-time"></div>
    </div>
    <div id="loading" class="alert alert-info text-center" style="display:none;">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Processing...
    </div>

    <!-- Collapsible Panel for Mock Form -->
    <div class="collapsible-panel" id="mock-form-panel">
        <div class="collapsible-panel-header">
            <h3>Mock API Form</h3>
            <span class="toggle-icon">&#x25BC;</span>
        </div>
        <div class="collapsible-panel-body">
            <!-- Mock Form -->
            <form id="mock-form">
                <input type="hidden" id="mock-id">

                <div class="form-group">
                    <label for="api_name">API Name:</label>
                    <input type="text" class="form-control" id="api_name" name="api_name" required
                        placeholder="No spaces allowed">
                    <small id="api-name-error" class="form-text text-danger" style="display:none;">API Name should not
                        contain whitespace.</small>
                </div>

                <!-- Dynamic Responses Container -->
                <div class="form-group">
                    <label>Responses:</label>
                    <div id="responses-container">
                        <!-- Initial Response Block -->
                        <div class="response-block">
                            <button type="button" class="btn btn-sm btn-danger remove-response-btn"
                                title="Remove Response">&times;</button>
                            <div class="form-group">
                                <label>Response (JSON):</label>
                                <textarea class="form-control response-text" rows="3" required
                                    placeholder='e.g., { "message": "Success" }'></textarea>
                            </div>
                            <div class="form-group">
                                <label>Weight:</label>
                                <input type="number" class="form-control weight-input" value="1" min="1" required>
                            </div>
                            <div class="response-actions">
                                <button type="button" class="btn btn-sm btn-outline-info format-json-btn">Format
                                    JSON</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary toggle-view-btn">Toggle
                                    View</button>
                                <!-- Add Header Button -->
                                <button type="button" class="btn btn-sm btn-outline-secondary add-header-btn">Add
                                    Header</button>
                                <!-- Add Condition Button -->
                                <button type="button" class="btn btn-sm btn-outline-secondary add-condition-btn">Add
                                    Condition</button>
                            </div>
                            <!-- Container for Headers -->
                            <div class="headers-container">
                                <!-- Header pairs will be added here -->
                            </div>
                            <!-- Container for Conditions -->
                            <div class="conditions-container">
                                <!-- Condition pairs will be added here -->
                            </div>
                            <!-- Expand/Squeeze and Format JSON Buttons -->
                            <div class="json-actions mt-3" style="display: none;">
                                <button type="button" class="btn btn-sm btn-outline-success expand-all-btn">Expand
                                    All</button>
                                <button type="button" class="btn btn-sm btn-outline-warning squeeze-all-btn">Squeeze
                                    All</button>
                                <button type="button" class="btn btn-sm btn-outline-info format-json-toggle-btn">Format
                                    JSON</button>
                            </div>
                        </div>
                    </div>
                    <!-- Add Response Button -->
                    <button type="button" class="btn btn-secondary btn-sm mt-2" id="addResponseBtn">Add
                        Response</button>
                </div>

                <!-- Mock-Level Fields -->
                <div class="form-group">
                    <label for="status">Status Code:</label>
                    <input type="text" class="form-control" id="status" name="status" list="status-codes" required
                        placeholder="e.g., 200">
                    <datalist id="status-codes">
                        <option value="200">200 OK</option>
                        <option value="201">201 Created</option>
                        <option value="204">204 No Content</option>
                        <option value="207">207 Multi-Status</option>
                        <option value="301">301 Moved Permanently</option>
                        <option value="304">304 Not Modified</option>
                        <option value="400">400 Bad Request</option>
                        <option value="401">401 Unauthorized</option>
                        <option value="403">403 Forbidden</option>
                        <option value="404">404 Not Found</option>
                        <option value="429">429 Too Many Requests</option>
                        <option value="500">500 Internal Server Error</option>
                        <option value="502">502 Bad Gateway</option>
                        <option value="503">503 Service Unavailable</option>
                        <option value="504">504 Gateway Timeout</option>
                    </datalist>
                    <small id="status-error" class="form-text text-danger" style="display:none;">Please enter a valid
                        HTTP status code.</small>
                </div>

                <div class="form-group">
                    <label for="delay">Response Delay (ms):</label>
                    <input type="number" class="form-control" id="delay" name="delay" value="0" required
                        placeholder="0-60000">
                    <small id="delay-error" class="form-text text-danger" style="display:none;">Delay should be a number
                        between 0 and 60000 ms.</small>
                </div>

                <div class="form-group">
                    <label for="method">HTTP Method:</label>
                    <select id="method" name="method" class="form-control">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>

                <button type="button" class="btn btn-primary btn-block" id="saveButton">Save Mock</button>
            </form>
        </div>
    </div>

    <!-- Floating Action Menu -->
    <div class="floating-menu">
        <div class="fab" id="menuToggle">
            &#x2B; <!-- Unicode for plus sign -->
        </div>
        <div class="action-buttons">
            <button type="button" class="btn btn-danger btn-sm" id="flushAllBtn" title="Flush All">
                Flush All
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="importBtn" title="Import">
                Import
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="exportBtn" title="Export">
                Export
            </button>
        </div>
    </div>

    <!-- Mock List Table -->
    <h2 class="text-center mb-3">Current Mocks</h2>
    <div class="table-responsive">
        <table id="mock-table" class="table table-striped table-bordered table-hover" style="width:100%">
            <thead class="thead-dark">
                <tr>
                    <!-- Checkbox Header (hidden initially) -->
                    <th class="select-checkbox" style="display: none;">
                        <input type="checkbox" id="select-all">
                    </th>
                    <th>API Name</th>
                    <th>Status</th>
                    <th>Delay (ms)</th>
                    <th>Method</th>
                    <th style="width: 150px;">Actions</th>
                </tr>
            </thead>
            <tbody id="mock-table-body">
                <!-- Mock entries will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Import File Input (Hidden) -->
    <input type="file" id="importFileInput" accept=".mock" style="display: none;">

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this mock?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flush All Confirmation Modal -->
    <div class="modal fade" id="flushConfirmationModal" tabindex="-1" aria-labelledby="flushConfirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="flushConfirmationModalLabel">Confirm Flush All</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete <strong>all</strong> mocks? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelFlushBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmFlushBtn">Flush All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overwrite Confirmation Modal -->
    <div class="modal fade" id="overwriteConfirmationModal" tabindex="-1"
        aria-labelledby="overwriteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="overwriteConfirmationModalLabel">Overwrite Mock</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    A mock with the name "<span id="existingMockName"></span>" already exists. Do you want to overwrite
                    it?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelOverwriteBtn">No</button>
                    <button type="button" class="btn btn-warning" id="confirmOverwriteBtn">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer with developer information -->
    <footer>
        <div>Developed by <a href="https://www.linkedin.com/in/pothiq/" target="_blank">Md Hasan Basri</a></div>
        <div class="version-info">Version 1.0.0 | Build Year: 2024</div>
    </footer>

    <!-- JavaScript for managing mock operations -->
    <script>
        $(document).ready(function () {
            let mockIdToDelete = null; // Variable to store the mock ID to delete
            let existingMocks = []; // To store existing mocks for import
            let importMocks = []; // To store mocks being imported
            let importIndex = 0; // Index for importing mocks

            // Load mocks on page load
            loadMocks();

            // Initialize the collapsible panel
            const mockFormPanel = $('#mock-form-panel');
            const mockFormBody = $('.collapsible-panel-body');
            const toggleIcon = $('.toggle-icon');

            // Initially collapse the panel
            mockFormPanel.removeClass('expanded');
            mockFormBody.hide();
            toggleIcon.html('&#x25BC;'); // Down arrow

            // Toggle panel on header click
            $('.collapsible-panel-header').on('click', function () {
                if ($('.collapsible-panel').hasClass('expanded')) {
                    $('.collapsible-panel').removeClass('expanded').find('.collapsible-panel-body').slideUp(500); // Slowed animation
                    $('.table-responsive').css('margin-top', '20px'); // Add margin below when collapsed
                } else {
                    $('.collapsible-panel').addClass('expanded').find('.collapsible-panel-body').slideDown(500); // Slowed animation
                    $('.table-responsive').css('margin-top', '0'); // Remove margin when expanded
                }
            });

            // Handler for adding new response blocks
            $('#addResponseBtn').on('click', function () {
                const responseBlock = `
                    <div class="response-block">
                        <button type="button" class="btn btn-sm btn-danger remove-response-btn" title="Remove Response">&times;</button>
                        <div class="form-group">
                            <label>Response (JSON):</label>
                            <textarea class="form-control response-text" rows="3" required
                                placeholder='e.g., { "message": "Success" }'></textarea>
                        </div>
                        <div class="form-group">
                            <label>Weight:</label>
                            <input type="number" class="form-control weight-input" value="1" min="1" required>
                        </div>
                        <div class="response-actions">
                            <button type="button" class="btn btn-sm btn-outline-info format-json-btn">Format JSON</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary toggle-view-btn">Toggle View</button>
                            <!-- Add Header Button -->
                            <button type="button" class="btn btn-sm btn-outline-secondary add-header-btn">Add Header</button>
                            <!-- Add Condition Button -->
                            <button type="button" class="btn btn-sm btn-outline-secondary add-condition-btn">Add Condition</button>
                        </div>
                        <!-- Container for Headers -->
                        <div class="headers-container">
                            <!-- Header pairs will be added here -->
                        </div>
                        <!-- Container for Conditions -->
                        <div class="conditions-container">
                            <!-- Condition pairs will be added here -->
                        </div>
                        <!-- Expand/Squeeze and Format JSON Buttons -->
                        <div class="json-actions mt-3" style="display: none;">
                            <button type="button" class="btn btn-sm btn-outline-success expand-all-btn">Expand All</button>
                            <button type="button" class="btn btn-sm btn-outline-warning squeeze-all-btn">Squeeze All</button>
                            <button type="button" class="btn btn-sm btn-outline-info format-json-toggle-btn">Format JSON</button>
                        </div>
                    </div>
                `;
                $('#responses-container').append(responseBlock);
            });

            // Handler for removing response blocks
            $('#responses-container').on('click', '.remove-response-btn', function () {
                $(this).closest('.response-block').remove();
            });

            // Handler for formatting JSON within a response block
            $('#responses-container').on('click', '.format-json-btn', function () {
                const responseTextarea = $(this).closest('.response-block').find('.response-text');
                try {
                    const json = JSON.parse(responseTextarea.val());
                    responseTextarea.val(JSON.stringify(json, null, 4));
                } catch (e) {
                    showAlert('Invalid JSON - Cannot format.', 'danger');
                }
            });

            // Handler for toggling JSON view within a response block
            $('#responses-container').on('click', '.toggle-view-btn', function () {
                const responseTextarea = $(this).closest('.response-block').find('.response-text');
                const currentVal = responseTextarea.val().trim();
                const toggleBtn = $(this);
                const jsonActions = $(this).closest('.response-block').find('.json-actions');

                // Prevent multiple pre elements from being added
                if (!responseTextarea.hasClass('json-view-enabled')) {
                    if (currentVal === "") {
                        showAlert('Invalid JSON - Cannot toggle view.', 'warning');
                        return;
                    }

                    try {
                        const json = JSON.parse(currentVal);
                        const collapsibleHtml = createCollapsibleJson(json);
                        responseTextarea.hide();
                        // Remove any existing pre elements to prevent duplication
                        $(this).closest('.response-block').find('.json-view').remove();
                        responseTextarea.after(`<pre class="json-view">${collapsibleHtml}</pre>`);
                        toggleBtn.text('Edit JSON');
                        responseTextarea.addClass('json-view-enabled');
                        // Show Expand All and Squeeze All, hide Format JSON
                        jsonActions.show();
                    } catch (e) {
                        showAlert('Invalid JSON - Cannot toggle view.', 'danger');
                    }
                } else {
                    // Remove the pre element and show the textarea again
                    $(this).closest('.response-block').find('.json-view').remove();
                    responseTextarea.show();
                    toggleBtn.text('Toggle View');
                    responseTextarea.removeClass('json-view-enabled');
                    // Hide Expand All and Squeeze All, show Format JSON
                    jsonActions.hide();
                }
            });

            // Handler for formatting JSON toggle button
            $('#responses-container').on('click', '.format-json-toggle-btn', function () {
                const responseTextarea = $(this).closest('.response-block').find('.response-text');
                try {
                    const json = JSON.parse(responseTextarea.val());
                    responseTextarea.val(JSON.stringify(json, null, 4));
                    showAlert('JSON formatted successfully.', 'success');
                } catch (e) {
                    showAlert('Invalid JSON - Cannot format.', 'danger');
                }
            });

            // Handler for adding headers within a response block
            $('#responses-container').on('click', '.add-header-btn', function () {
                const headersContainer = $(this).closest('.response-block').find('.headers-container');
                const headerPair = `
                    <div class="header-pair">
                        <input type="text" class="form-control header-key" placeholder="Header Key" required>
                        <input type="text" class="form-control header-value" placeholder="Header Value" required>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-header-btn" title="Remove Header">&times;</button>
                    </div>
                `;
                headersContainer.append(headerPair);
            });

            // Handler for removing headers within a response block
            $('#responses-container').on('click', '.remove-header-btn', function () {
                $(this).closest('.header-pair').remove();
            });

            // Handler for adding conditions within a response block
            $('#responses-container').on('click', '.add-condition-btn', function () {
                const conditionsContainer = $(this).closest('.response-block').find('.conditions-container');
                const conditionPair = `
                    <div class="condition-pair">
                        <input type="text" class="form-control condition-key" placeholder="Condition Key" required>
                        <input type="text" class="form-control condition-value" placeholder="Condition Value" required>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-condition-btn" title="Remove Condition">&times;</button>
                    </div>
                `;
                conditionsContainer.append(conditionPair);
            });

            // Handler for removing conditions within a response block
            $('#responses-container').on('click', '.remove-condition-btn', function () {
                $(this).closest('.condition-pair').remove();
            });

            // Handler for expanding all JSON sections within a response block
            $('#responses-container').on('click', '.expand-all-btn', function () {
                const jsonView = $(this).closest('.response-block').find('.json-view');
                jsonView.find('.collapsible.collapsed').each(function () {
                    $(this).removeClass('collapsed').addClass('expanded');
                    $(this).next('.collapsible-content').slideDown(300);
                });
            });

            // Handler for squeezing all JSON sections within a response block
            $('#responses-container').on('click', '.squeeze-all-btn', function () {
                const jsonView = $(this).closest('.response-block').find('.json-view');
                jsonView.find('.collapsible.expanded').each(function () {
                    $(this).removeClass('expanded').addClass('collapsed');
                    $(this).next('.collapsible-content').slideUp(300);
                });
            });

            // Save Mock Button Handler
            $('#saveButton').on('click', function () {
                if (!validateForm()) return;

                $('#loading').show();
                const startTime = performance.now(); // Start time

                // Collect all response variants
                const responseVariants = [];
                $('.response-block').each(function () {
                    const response = $(this).find('.response-text').val();
                    const weight = parseInt($(this).find('.weight-input').val(), 10);

                    // Collect headers for this response
                    const headers = {};
                    $(this).find('.header-pair').each(function () {
                        const key = $(this).find('.header-key').val().trim();
                        const value = $(this).find('.header-value').val().trim();
                        if (key && value) {
                            headers[key] = value;
                        }
                    });

                    // Collect conditions for this response
                    const conditionsObj = {};
                    $(this).find('.condition-pair').each(function () {
                        const key = $(this).find('.condition-key').val().trim();
                        const value = $(this).find('.condition-value').val().trim();
                        if (key && value) {
                            conditionsObj[key] = value;
                        }
                    });

                    // Serialize conditions into a JSON string
                    const condition = Object.keys(conditionsObj).length > 0 ? JSON.stringify(conditionsObj) : null;

                    responseVariants.push({
                        response: response,
                        weight: weight,
                        headers: headers,
                        condition: condition
                    });
                });

                // Collect mock-level fields
                const formData = {
                    api_name: $('#api_name').val(),
                    method: $('#method').val(),
                    status: parseInt($('#status').val(), 10),
                    delay: parseInt($('#delay').val(), 10),
                    timestamp: new Date().toISOString(),
                    response_variants: responseVariants.map(variant => ({
                        response: variant.response,
                        weight: variant.weight,
                        response_headers: Object.keys(variant.headers).length > 0 ? variant.headers : null,
                        condition: variant.condition
                    }))
                };

                const id = $('#mock-id').val();
                const url = id ? `/update-mock/${id}` : '/save-mock';
                const type = id ? 'PUT' : 'POST';

                $.ajax({
                    type: type,
                    url: url,
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function () {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text(id ? 'Mock updated successfully!' : 'Mock API saved successfully!');
                        $('#processing-time').text(`Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-success').fadeIn().delay(3000).fadeOut();
                        $('#loading').hide();
                        loadMocks();
                        $('#mock-form')[0].reset();
                        $('#responses-container').html(`
                            <div class="response-block">
                                <button type="button" class="btn btn-sm btn-danger remove-response-btn" title="Remove Response">&times;</button>
                                <div class="form-group">
                                    <label>Response (JSON):</label>
                                    <textarea class="form-control response-text" rows="3" required
                                        placeholder='e.g., { "message": "Success" }'></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Weight:</label>
                                    <input type="number" class="form-control weight-input" value="1" min="1" required>
                                </div>
                                <div class="response-actions">
                                    <button type="button" class="btn btn-sm btn-outline-info format-json-btn">Format JSON</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary toggle-view-btn">Toggle View</button>
                                    <!-- Add Header Button -->
                                    <button type="button" class="btn btn-sm btn-outline-secondary add-header-btn">Add Header</button>
                                    <!-- Add Condition Button -->
                                    <button type="button" class="btn btn-sm btn-outline-secondary add-condition-btn">Add Condition</button>
                                </div>
                                <!-- Container for Headers -->
                                <div class="headers-container">
                                    <!-- Header pairs will be added here -->
                                </div>
                                <!-- Container for Conditions -->
                                <div class="conditions-container">
                                    <!-- Condition pairs will be added here -->
                                </div>
                                <!-- Expand/Squeeze and Format JSON Buttons -->
                                <div class="json-actions mt-3" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-outline-success expand-all-btn">Expand All</button>
                                    <button type="button" class="btn btn-sm btn-outline-warning squeeze-all-btn">Squeeze All</button>
                                    <button type="button" class="btn btn-sm btn-outline-info format-json-toggle-btn">Format JSON</button>
                                </div>
                            </div>
                        `);
                        $('#mock-id').val('');
                        // Keep the panel expanded after saving
                        if (!mockFormPanel.hasClass('expanded')) {
                            mockFormPanel.addClass('expanded').find('.collapsible-panel-body').slideDown(500);
                            toggleIcon.html('&#x25B2;'); // Up arrow
                        }
                    },
                    error: function (xhr) {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Failed to save or update mock.');
                        $('#processing-time').text(`Error Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-danger').fadeIn().delay(5000).fadeOut();
                        $('#loading').hide();
                    }
                });
            });

            function loadMocks() {
                $.get('/list-mocks', function (mocks) {
                    existingMocks = mocks; // Store existing mocks for import
                    $('#mock-table').DataTable().destroy();
                    $('#mock-table-body').empty();
                    mocks.forEach(mock => addMockToTable(mock));
                    initializeDataTable();
                }).fail(function () {
                    showAlert('Failed to load mocks.', 'danger');
                });
            }

            function addMockToTable(mock) {
                $('#mock-table-body').append(
                    `<tr data-id="${mock.id}">
                        <!-- Checkbox Cell (hidden initially) -->
                        <td class="select-checkbox" style="display: none;">
                            <input type="checkbox" class="row-checkbox">
                        </td>
                        <td><a href="/mock/${mock.api_name}" target="_blank">${mock.api_name}</a></td>
                        <td>${mock.status}</td>
                        <td>${mock.delay}</td>
                        <td>${mock.method}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>
                            <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                        </td>
                    </tr>`
                );
            }

            // Event delegation for Edit and Delete buttons
            $('#mock-table-body').on('click', '.edit-btn', function () {
                const id = $(this).closest('tr').data('id');
                editMock(id);
            });

            $('#mock-table-body').on('click', '.delete-btn', function () {
                mockIdToDelete = $(this).closest('tr').data('id');
                // Show the confirmation modal with animation
                $('#deleteConfirmationModal').modal('show');
            });

            // Handle the confirm delete button click in the modal
            $('#confirmDeleteBtn').on('click', function () {
                // Proceed with deletion
                $('#deleteConfirmationModal').modal('hide');
                $('#loading').show();
                const startTime = performance.now(); // Start time
                $.ajax({
                    type: 'DELETE',
                    url: `/delete-mock/${mockIdToDelete}`,
                    success: function () {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Mock deleted successfully.');
                        $('#processing-time').text(`Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-success').fadeIn().delay(3000).fadeOut();
                        $('#loading').hide();
                        loadMocks();
                    },
                    error: function (xhr) {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Failed to delete mock.');
                        $('#processing-time').text(`Error Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-danger').fadeIn().delay(5000).fadeOut();
                        $('#loading').hide();
                    }
                });
            });

            // Cancel button handler for Delete Modal
            $('#cancelDeleteBtn').on('click', function () {
                // Hide the modal
                $('#deleteConfirmationModal').modal('hide');
            });

            // Flush All Confirmation Modal Handlers
            $('#flushAllBtn').on('click', function () {
                $('#flushConfirmationModal').modal('show');
            });

            // Handle Flush All
            $('#confirmFlushBtn').on('click', function () {
                // Hide the confirmation modal
                $('#flushConfirmationModal').modal('hide');

                // Show loading spinner
                $('#loading').show();
                const startTime = performance.now(); // Start time

                // Send DELETE request
                $.ajax({
                    type: 'DELETE',
                    url: '/delete-all-mocks',
                    success: function () {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('All mocks have been successfully deleted.');
                        $('#processing-time').text(`Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-success').fadeIn().delay(3000).fadeOut();
                        $('#loading').hide();
                        loadMocks(); // Reload the table
                    },
                    error: function (xhr) {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Failed to delete all mocks.');
                        $('#processing-time').text(`Error Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-danger').fadeIn().delay(5000).fadeOut();
                        $('#loading').hide();
                    }
                });
            });

            $('#cancelFlushBtn').on('click', function () {
                // Hide the flush confirmation modal
                $('#flushConfirmationModal').modal('hide');
            });

            function editMock(id) {
                $('#loading').show();
                const startTime = performance.now(); // Start time
                $.get(`/get-mock/${id}`, function (mock) {
                    $('#api_name').val(mock.api_name);
                    // Clear existing responses
                    $('#responses-container').empty();

                    // Populate response variants
                    if (mock.response_variants && mock.response_variants.length > 0) {
                        mock.response_variants.forEach(variant => {
                            // Construct header pairs if headers exist
                            let headersHtml = '';
                            if (variant.response_headers && Object.keys(variant.response_headers).length > 0) {
                                for (const key in variant.response_headers) {
                                    const value = variant.response_headers[key];
                                    headersHtml += `
                                        <div class="header-pair">
                                            <input type="text" class="form-control header-key" placeholder="Header Key" value="${key}" required>
                                            <input type="text" class="form-control header-value" placeholder="Header Value" value="${value}" required>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-header-btn" title="Remove Header">&times;</button>
                                        </div>
                                    `;
                                }
                            }

                            // Construct condition pairs if conditions exist
                            let conditionsHtml = '';
                            if (variant.condition) {
                                try {
                                    const conditionsObj = JSON.parse(variant.condition);
                                    for (const key in conditionsObj) {
                                        const value = conditionsObj[key];
                                        conditionsHtml += `
                                            <div class="condition-pair">
                                                <input type="text" class="form-control condition-key" placeholder="Condition Key" value="${key}" required>
                                                <input type="text" class="form-control condition-value" placeholder="Condition Value" value="${value}" required>
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-condition-btn" title="Remove Condition">&times;</button>
                                            </div>
                                        `;
                                    }
                                } catch (e) {
                                    console.error('Failed to parse conditions:', e);
                                }
                            }

                            const responseBlock = `
                                <div class="response-block">
                                    <button type="button" class="btn btn-sm btn-danger remove-response-btn" title="Remove Response">&times;</button>
                                    <div class="form-group">
                                        <label>Response (JSON):</label>
                                        <textarea class="form-control response-text" rows="3" required
                                            placeholder='e.g., { "message": "Success" }'>${variant.response}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Weight:</label>
                                        <input type="number" class="form-control weight-input" value="${variant.weight}" min="1" required>
                                    </div>
                                    <div class="response-actions">
                                        <button type="button" class="btn btn-sm btn-outline-info format-json-btn">Format JSON</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary toggle-view-btn">Toggle View</button>
                                        <!-- Add Header Button -->
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-header-btn">Add Header</button>
                                        <!-- Add Condition Button -->
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-condition-btn">Add Condition</button>
                                    </div>
                                    <!-- Container for Headers -->
                                    <div class="headers-container">
                                        ${headersHtml}
                                    </div>
                                    <!-- Container for Conditions -->
                                    <div class="conditions-container">
                                        ${conditionsHtml}
                                    </div>
                                    <!-- Expand/Squeeze and Format JSON Buttons -->
                                    <div class="json-actions mt-3" style="display: none;">
                                        <button type="button" class="btn btn-sm btn-outline-success expand-all-btn">Expand All</button>
                                        <button type="button" class="btn btn-sm btn-outline-warning squeeze-all-btn">Squeeze All</button>
                                        <button type="button" class="btn btn-sm btn-outline-info format-json-toggle-btn">Format JSON</button>
                                    </div>
                                </div>
                            `;
                            $('#responses-container').append(responseBlock);
                        });
                    } else {
                        // If no response variants, add a default one
                        const defaultResponse = `
                            <div class="response-block">
                                <button type="button" class="btn btn-sm btn-danger remove-response-btn" title="Remove Response">&times;</button>
                                <div class="form-group">
                                    <label>Response (JSON):</label>
                                    <textarea class="form-control response-text" rows="3" required
                                        placeholder='e.g., { "message": "Success" }'></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Weight:</label>
                                    <input type="number" class="form-control weight-input" value="1" min="1" required>
                                </div>
                                <div class="response-actions">
                                    <button type="button" class="btn btn-sm btn-outline-info format-json-btn">Format JSON</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary toggle-view-btn">Toggle View</button>
                                    <!-- Add Header Button -->
                                    <button type="button" class="btn btn-sm btn-outline-secondary add-header-btn">Add Header</button>
                                    <!-- Add Condition Button -->
                                    <button type="button" class="btn btn-sm btn-outline-secondary add-condition-btn">Add Condition</button>
                                </div>
                                <!-- Container for Headers -->
                                <div class="headers-container">
                                    <!-- Header pairs will be added here -->
                                </div>
                                <!-- Container for Conditions -->
                                <div class="conditions-container">
                                    <!-- Condition pairs will be added here -->
                                </div>
                                <!-- Expand/Squeeze and Format JSON Buttons -->
                                <div class="json-actions mt-3" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-outline-success expand-all-btn">Expand All</button>
                                    <button type="button" class="btn btn-sm btn-outline-warning squeeze-all-btn">Squeeze All</button>
                                    <button type="button" class="btn btn-sm btn-outline-info format-json-toggle-btn">Format JSON</button>
                                </div>
                            </div>
                        `;
                        $('#responses-container').append(defaultResponse);
                    }

                    // Set mock-level fields
                    $('#status').val(mock.status);
                    $('#delay').val(mock.delay);
                    $('#method').val(mock.method);
                    $('#mock-id').val(mock.id);

                    const endTime = performance.now(); // End time
                    const duration = Math.round(endTime - startTime); // Duration in ms
                    $('#processing-time').text(`Processing Time: ${duration} ms`);
                    $('#loading').hide();
                    // Expand the panel if it's collapsed
                    if (!mockFormPanel.hasClass('expanded')) {
                        mockFormPanel.addClass('expanded').find('.collapsible-panel-body').slideDown(500);
                        toggleIcon.html('&#x25B2;'); // Up arrow
                    }
                }); // <-- Correctly closes the $.get function
            }

            function validateForm() {
                let isValid = true;

                const apiName = $('#api_name').val();
                if (/\s/.test(apiName)) {
                    $('#api-name-error').show();
                    isValid = false;
                } else {
                    $('#api-name-error').hide();
                }

                const status = $('#status').val();
                if (!/^\d{3}$/.test(status)) {
                    $('#status-error').show();
                    isValid = false;
                } else {
                    $('#status-error').hide();
                }

                const delay = parseInt($('#delay').val(), 10);
                if (isNaN(delay) || delay < 0 || delay > 60000) {
                    $('#delay-error').show();
                    isValid = false;
                } else {
                    $('#delay-error').hide();
                }

                // Validate each response block
                let errorFound = false;
                $('.response-block').each(function () {
                    const response = $(this).find('.response-text').val().trim();
                    const weight = $(this).find('.weight-input').val().trim();

                    if (response === '') {
                        showAlert('All response fields must be filled.', 'warning');
                        isValid = false;
                        errorFound = true;
                        return false; // Break out of each loop
                    }

                    // Validate JSON
                    try {
                        JSON.parse(response);
                    } catch (e) {
                        showAlert('Invalid JSON in one of the responses.', 'danger');
                        isValid = false;
                        errorFound = true;
                        return false; // Break out of each loop
                    }

                    // Validate weight
                    if (!/^\d+$/.test(weight) || parseInt(weight, 10) < 1) {
                        showAlert('All weights must be positive integers.', 'warning');
                        isValid = false;
                        errorFound = true;
                        return false; // Break out of each loop
                    }

                    // Validate headers (if any)
                    $(this).find('.header-pair').each(function () {
                        const key = $(this).find('.header-key').val().trim();
                        const value = $(this).find('.header-value').val().trim();

                        if (key === '' || value === '') {
                            showAlert('All header fields must be filled.', 'warning');
                            isValid = false;
                            errorFound = true;
                            return false; // Break out of each loop
                        }
                    });

                    // Validate conditions (if any)
                    $(this).find('.condition-pair').each(function () {
                        const key = $(this).find('.condition-key').val().trim();
                        const value = $(this).find('.condition-value').val().trim();

                        if (key === '' || value === '') {
                            showAlert('All condition fields must be filled.', 'warning');
                            isValid = false;
                            errorFound = true;
                            return false; // Break out of each loop
                        }
                    });

                    if (errorFound) return false; // Break out of each loop
                });

                return isValid;
            }

            // Function to show alerts using Bootstrap alerts
            function showAlert(message, type) {
                // type: 'success', 'danger', 'warning', 'info'
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `;
                $('#notification').html(alertHtml).fadeIn().delay(5000).fadeOut();
            }

            // Function to create collapsible JSON HTML
            function createCollapsibleJson(json) {
                if (typeof json !== 'object' || json === null) {
                    return styleJsonValue(json);
                }

                let html = '';
                const isArray = Array.isArray(json);
                html += isArray ? '[<br>' : '{<br>';
                for (const key in json) {
                    const value = json[key];
                    const isObject = typeof value === 'object' && value !== null;

                    html += `<div style="margin-left: 20px;">`;
                    if (!isArray) {
                        html += `<span class="json-key">"${key}"</span>: `;
                    }
                    if (isObject) {
                        html += `<span class="collapsible collapsed"><span class="collapsible-placeholder">{...}</span></span>`;
                        html += `<div class="collapsible-content">${createCollapsibleJson(value)}</div>`;
                    } else {
                        html += `${styleJsonValue(value)},<br>`;
                    }
                    html += '</div>';
                }
                html += isArray ? ']<br>' : '}<br>';
                return html;
            }

            // Function to style JSON values based on their type
            function styleJsonValue(value) {
                if (typeof value === 'string') {
                    const isPlaceholder = value.startsWith("{{") && value.endsWith("}}");
                    const className = isPlaceholder ? "json-placeholder" : "json-string";
                    return `<span class="${className}">"${value}"</span>`;
                } else if (typeof value === 'number') {
                    return `<span class="json-number">${value}</span>`;
                } else if (typeof value === 'boolean') {
                    return `<span class="json-boolean">${value}</span>`;
                } else if (value === null) {
                    return `<span class="json-null">null</span>`;
                }
            }

            // Function to initialize DataTable
            function initializeDataTable() {
                $('#mock-table').DataTable({
                    "order": [[1, "asc"]], // Default sorting on API Name (adjusted index due to checkbox column)
                    "columnDefs": [
                        { "orderable": false, "targets": [0, 5] }, // Disable sorting on Checkbox and Actions columns
                        { "width": "5%", "targets": 0 } // Adjust width for checkbox column
                    ],
                    "pagingType": "simple_numbers",
                    "language": {
                        "search": "_INPUT_",
                        "searchPlaceholder": "Search mocks..."
                    },
                    "autoWidth": false,
                    "responsive": true
                });
            }

            // Function to handle Export functionality
            $('#exportBtn').on('click', function () {
                const isExportMode = $(this).data('export-mode') || false;

                if (!isExportMode) {
                    enableExportMode();
                } else {
                    const selectedMocks = [];
                    $('#mock-table-body tr').each(function () {
                        const $checkbox = $(this).find('.row-checkbox');
                        if ($checkbox.is(':checked')) {
                            const id = $(this).data('id');
                            const mock = existingMocks.find(m => m.id === id);
                            if (mock) {
                                selectedMocks.push(mock);
                            }
                        }
                    });

                    if (selectedMocks.length === 0) {
                        showAlert('Please select at least one mock to export.', 'warning');
                        return;
                    }

                    const dataStr = JSON.stringify(selectedMocks, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mocks_backup.mock';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    disableExportMode();
                }
            });

            function enableExportMode() {
                $('#exportBtn').data('export-mode', true).text('Download');
                $('#mock-table thead th.select-checkbox').show();
                $('#mock-table tbody td.select-checkbox').show();
                $('#select-all').prop('checked', false);
            }

            function disableExportMode() {
                $('#exportBtn').data('export-mode', false).text('Export');
                $('#mock-table thead th.select-checkbox').hide();
                $('#mock-table tbody td.select-checkbox').hide();
                $('.row-checkbox').prop('checked', false);
            }

            // Select All functionality
            $('#select-all').on('click', function () {
                const isChecked = $(this).is(':checked');
                $('.row-checkbox').prop('checked', isChecked);
            });

            // Function to handle Import functionality
            $('#importBtn').on('click', function () {
                $('#importFileInput').click();
            });

            $('#importFileInput').on('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const decodedData = e.target.result;
                            importMocks = JSON.parse(decodedData);
                            importIndex = 0;
                            processImport();
                        } catch (error) {
                            showAlert('Invalid or corrupted file.', 'danger');
                        }
                    };
                    reader.readAsText(file);
                }
            });

            function processImport() {
                if (importIndex >= importMocks.length) {
                    loadMocks();
                    showAlert('Import process completed.', 'success');
                    return;
                }
                const mock = importMocks[importIndex];
                const existingMock = existingMocks.find(m => m.api_name === mock.api_name);
                if (existingMock) {
                    $('#existingMockName').text(mock.api_name);
                    $('#overwriteConfirmationModal').modal('show');
                } else {
                    saveImportedMock(mock);
                }
            }

            $('#confirmOverwriteBtn').on('click', function () {
                const mock = importMocks[importIndex];
                saveImportedMock(mock, true);
                $('#overwriteConfirmationModal').modal('hide');
            });

            $('#cancelOverwriteBtn').on('click', function () {
                importIndex++;
                processImport();
                $('#overwriteConfirmationModal').modal('hide');
            });

            function saveImportedMock(mock, overwrite = false) {
                // Ensure timestamp is present
                if (!mock.timestamp) {
                    mock.timestamp = new Date().toISOString();
                }

                const url = overwrite ? `/update-mock/${mock.id}` : '/save-mock';
                const type = overwrite ? 'PUT' : 'POST';

                $.ajax({
                    type: type,
                    url: url,
                    contentType: 'application/json',
                    data: JSON.stringify(mock),
                    success: function () {
                        importIndex++;
                        processImport();
                    },
                    error: function (xhr) {
                        showAlert('Failed to import mock: ' + xhr.responseText, 'danger');
                        importIndex++;
                        processImport();
                    }
                });
            }

            // Floating menu toggle
            $('#menuToggle').on('click', function () {
                $('.floating-menu').toggleClass('open');
            });

        }); // <-- Correctly closes the $(document).ready() function
    </script>
</body>

</html>