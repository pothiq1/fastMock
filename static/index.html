<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Mock API Manager</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- DataTables with Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <!-- Custom CSS for styling -->
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 80px;
            /* Ensure footer doesn't overlap content */
        }

        h1,
        h2 {
            color: #343a40;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .table thead th {
            vertical-align: middle;
            text-align: center;
        }

        .table tbody td {
            vertical-align: middle;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 0.5em;
            display: inline-block;
            width: auto;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.5em 1em;
        }

        .dataTables_wrapper .dataTables_info {
            font-size: 0.9em;
        }

        .dataTables_wrapper .dataTables_length select {
            width: auto;
        }

        .json-view {
            font-family: monospace;
            padding: 10px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        /* Collapsible JSON styles */
        .collapsible {
            cursor: pointer;
            font-weight: bold;
        }

        .expanded::before {
            content: "- ";
            color: #007bff;
        }

        .collapsed::before {
            content: "+ ";
            color: #007bff;
        }

        .collapsible-placeholder {
            display: inline;
            color: #777;
        }

        .collapsible-content {
            display: none;
            margin-left: 20px;
        }

        /* JSON syntax highlighting */
        .json-key {
            color: #d9534f;
        }

        .json-string {
            color: #5bc0de;
        }

        .json-number {
            color: #f0ad4e;
        }

        .json-boolean {
            color: #5cb85c;
        }

        .json-null {
            color: #777;
        }

        .json-placeholder {
            color: #ff00ff;
            font-style: italic;
        }

        footer {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.875em;
            color: #555;
            padding: 5px 0;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid #ddd;
        }

        footer a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        footer a:hover {
            text-decoration: underline;
        }

        footer .version-info {
            color: #777;
            margin-top: 5px;
            font-size: 0.85em;
        }

        /* Modal custom styles */
        .modal-content {
            border-radius: 10px;
        }

        .modal-header {
            border-bottom: none;
        }

        .modal-footer {
            border-top: none;
        }

        .modal-body {
            font-size: 1.1em;
        }

        .modal.fade .modal-dialog {
            transform: translateY(-50px);
            transition: transform 0.5s ease-out;
            /* Slowed down animation */
        }

        .modal.show .modal-dialog {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 767.98px) {
            .table-responsive {
                overflow-x: auto;
            }

            .btn {
                margin-bottom: 5px;
            }

            /* Adjust floating menu position on smaller screens */
            .floating-menu {
                top: 10px;
                right: 10px;
            }
        }

        /* Styles for the collapsible panel */
        .collapsible-panel {
            border: 1px solid #ced4da;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
            /* Ensure consistent spacing */
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Added shadow */
            transition: box-shadow 0.3s ease;
        }

        .collapsible-panel.expanded {
            margin-top: 0;
            /* Ensures no extra spacing at the top */
            background-color: #ffffff;
            /* Matches the panel's background */
        }

        .collapsible-panel:not(.expanded)+.table-responsive {
            margin-top: 20px;
            /* Adds gap between the collapsed panel and Current Mocks */
        }

        .collapsible-panel-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ced4da;
        }

        .collapsible-panel.expanded:before {
            content: none;
            /* Ensures nothing is displayed */
            display: none;
            /* Ensures no space is occupied */
        }


        .collapsible-panel.expanded .collapsible-panel-header {
            border-bottom: none;
        }

        .collapsible-panel-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .collapsible-panel-header .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.5s;
            /* Slowed down rotation */
        }

        .collapsible-panel-body {
            padding: 15px;
            margin: 0;
            display: none;
            transition: all 0.5s ease;
            /* Slowed down animation */
        }

        .collapsible-panel.expanded .collapsible-panel-body {
            display: block;
            margin-top: 0;
            /* Removes extra margin causing white space */
            padding: 15px;
            /* Ensure content has proper spacing */
        }

        .collapsible-panel.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .text-action {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }

        .text-action:hover {
            text-decoration: none;
        }

        /* Styles for Floating Action Menu */
        .floating-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Added shadow */
        }

        .floating-menu .fab {
            width: 60px;
            height: 60px;
            background-color: #007bff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, background-color 0.3s ease;
            font-size: 24px;
            /* Increased font size for visibility */
            user-select: none;
        }

        .floating-menu .fab:hover {
            background-color: #0056b3;
        }

        /* Removed image inside fab and added "+" symbol */
        /* .floating-menu .fab img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%; /* Keeps the image circular 
        } */

        .floating-menu .action-buttons {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-top: 10px;
        }

        .floating-menu .action-buttons button {
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .floating-menu.open .action-buttons button {
            opacity: 1;
            transform: translateY(0);
        }

        .floating-menu .action-buttons button:last-child {
            margin-bottom: 0;
        }

        /* Styles for the extra checkbox column */
        .select-checkbox {
            text-align: center;
        }

        .select-checkbox input {
            margin: 0;
        }

        /* Adjust table when checkboxes are shown */
        .table-selectable tbody tr.selected {
            background-color: #d1ecf1;
        }

        /* Notification Styling */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 250px;
        }

        /* Added processing time styling */
        .processing-time {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables with Bootstrap 4 JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
</head>

<body class="container my-5">
    <h1 class="text-center mb-4">Mock API Manager</h1>

    <!-- Notification and Loading Indicators -->
    <div id="notification" class="alert alert-success text-center" style="display:none;">
        <span id="notification-message">Mock API saved successfully!</span>
        <div class="processing-time" id="processing-time"></div>
    </div>
    <div id="loading" class="alert alert-info text-center" style="display:none;">Processing...</div>

    <!-- Collapsible Panel for Mock Form -->
    <div class="collapsible-panel" id="mock-form-panel">
        <div class="collapsible-panel-header">
            <h3>Mock API Form</h3>
            <span class="toggle-icon">&#x25BC;</span>
        </div>
        <div class="collapsible-panel-body">
            <!-- Mock Form -->
            <form id="mock-form">
                <input type="hidden" id="mock-id">

                <div class="form-group">
                    <label for="api_name">API Name:</label>
                    <input type="text" class="form-control" id="api_name" name="api_name" required
                        placeholder="No spaces allowed">
                    <small id="api-name-error" class="form-text text-danger" style="display:none;">API Name should not
                        contain whitespace.</small>
                </div>

                <div class="form-group">
                    <label for="response">Response (JSON):</label>
                    <textarea class="form-control" id="response" name="response" rows="3" required></textarea>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <small id="response-info" class="form-text text-muted">Characters: 0 | Size: 0 KB</small>
                        <div>
                            <span id="formatJsonBtn" class="text-action mr-3" title="Format JSON">Format JSON</span>
                            <span id="expandAllBtn" class="text-action mr-3" title="Expand All"
                                style="display: none;">Expand All</span>
                            <span id="squeezeAllBtn" class="text-action mr-3" title="Squeeze All"
                                style="display: none;">Squeeze All</span>
                            <span id="toggleJsonViewBtn" class="text-action" title="Toggle JSON View">Toggle View</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="status">Status Code:</label>
                    <input type="text" class="form-control" id="status" name="status" list="status-codes" required
                        placeholder="e.g., 200">
                    <datalist id="status-codes">
                        <option value="200">200 OK</option>
                        <option value="201">201 Created</option>
                        <option value="204">204 No Content</option>
                        <option value="207">207 Multi-Status</option>
                        <option value="301">301 Moved Permanently</option>
                        <option value="304">304 Not Modified</option>
                        <option value="400">400 Bad Request</option>
                        <option value="401">401 Unauthorized</option>
                        <option value="403">403 Forbidden</option>
                        <option value="404">404 Not Found</option>
                        <option value="429">429 Too Many Requests</option>
                        <option value="500">500 Internal Server Error</option>
                        <option value="502">502 Bad Gateway</option>
                        <option value="503">503 Service Unavailable</option>
                        <option value="504">504 Gateway Timeout</option>
                    </datalist>
                    <small id="status-error" class="form-text text-danger" style="display:none;">Please enter a valid
                        HTTP status code.</small>
                </div>

                <div class="form-group">
                    <label for="delay">Response Delay (ms):</label>
                    <input type="number" class="form-control" id="delay" name="delay" value="0" required
                        placeholder="0-60000">
                    <small id="delay-error" class="form-text text-danger" style="display:none;">Delay should be a number
                        between 0 and 60000 ms.</small>
                </div>

                <div class="form-group">
                    <label for="method">HTTP Method:</label>
                    <select id="method" name="method" class="form-control">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>

                <button type="button" class="btn btn-primary btn-block" id="saveButton">Save Mock</button>
            </form>
        </div>
    </div>

    <!-- Floating Action Menu -->
    <div class="floating-menu">
        <div class="fab" id="menuToggle">
            &#x2B; <!-- Unicode for plus sign -->
        </div>
        <div class="action-buttons">
            <button type="button" class="btn btn-danger btn-sm" id="flushAllBtn" title="Flush All">
                Flush All
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="importBtn" title="Import">
                Import
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="exportBtn" title="Export">
                Export
            </button>
        </div>
    </div>

    <!-- Mock List Table -->
    <h2 class="text-center mb-3">Current Mocks</h2>
    <div class="table-responsive">
        <table id="mock-table" class="table table-striped table-bordered table-hover" style="width:100%">
            <thead class="thead-dark">
                <tr>
                    <!-- Checkbox Header (hidden initially) -->
                    <th class="select-checkbox" style="display: none;">
                        <input type="checkbox" id="select-all">
                    </th>
                    <th>API Name</th>
                    <th>Status</th>
                    <th>Delay (ms)</th>
                    <th>Method</th>
                    <th style="width: 150px;">Actions</th>
                </tr>
            </thead>
            <tbody id="mock-table-body">
                <!-- Mock entries will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Import File Input (Hidden) -->
    <input type="file" id="importFileInput" accept=".mock" style="display: none;">

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this mock?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flush All Confirmation Modal -->
    <div class="modal fade" id="flushConfirmationModal" tabindex="-1" aria-labelledby="flushConfirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="flushConfirmationModalLabel">Confirm Flush All</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete <strong>all</strong> mocks? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelFlushBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmFlushBtn">Flush All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overwrite Confirmation Modal -->
    <div class="modal fade" id="overwriteConfirmationModal" tabindex="-1"
        aria-labelledby="overwriteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-warning" id="overwriteConfirmationModalLabel">Overwrite Mock</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    A mock with the name "<span id="existingMockName"></span>" already exists. Do you want to overwrite
                    it?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelOverwriteBtn">No</button>
                    <button type="button" class="btn btn-warning" id="confirmOverwriteBtn">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer with developer information -->
    <footer>
        <div>Developed by <a href="https://www.linkedin.com/in/pothiq/" target="_blank">Md Hasan Basri</a></div>
        <div class="version-info">Version 1.0.0 | Build Year: 2024</div>
    </footer>

    <!-- JavaScript for managing mock operations -->
    <script>
        $(document).ready(function () {
            let isJsonView = false;
            let mockIdToDelete = null; // Variable to store the mock ID to delete
            let existingMocks = []; // To store existing mocks for import
            let importMocks = []; // To store mocks being imported
            let importIndex = 0; // Index for importing mocks

            // Load mocks on page load
            loadMocks();

            // Initialize the collapsible panel
            const mockFormPanel = $('#mock-form-panel');
            const mockFormBody = $('.collapsible-panel-body');
            const toggleIcon = $('.toggle-icon');

            // Initially collapse the panel
            mockFormPanel.removeClass('expanded');
            mockFormBody.hide();
            toggleIcon.html('&#x25BC;'); // Down arrow

            // Add margin dynamically when collapsed
            $('.collapsible-panel-header').on('click', function () {
                if ($('.collapsible-panel').hasClass('expanded')) {
                    $('.collapsible-panel').removeClass('expanded').find('.collapsible-panel-body').slideUp(500); // Slowed animation
                    $('.table-responsive').css('margin-top', '20px'); // Add margin below when collapsed
                } else {
                    $('.collapsible-panel').addClass('expanded').find('.collapsible-panel-body').slideDown(500); // Slowed animation
                    $('.table-responsive').css('margin-top', '0'); // Remove margin when expanded
                }
            });


            function expandPanel() {
                mockFormPanel.addClass('expanded');
                mockFormBody.fadeIn(500); // Slowed animation
                toggleIcon.html('&#x25B2;'); // Up arrow
            }

            function collapsePanel() {
                mockFormPanel.removeClass('expanded');
                mockFormBody.fadeOut(500); // Slowed animation
                toggleIcon.html('&#x25BC;'); // Down arrow
            }

            // Toggle JSON View
            $('#toggleJsonViewBtn').on('click', function (event) {
                event.preventDefault();
                const responseElement = $('#response');
                const responseContent = responseElement.val().trim();

                if (!isJsonView) {
                    try {
                        const json = JSON.parse(responseContent);
                        const collapsibleHtml = createCollapsibleJson(json);
                        responseElement.hide();
                        $('#json-view').remove();
                        responseElement.after(`<pre id="json-view" class="json-view">${collapsibleHtml}</pre>`);
                        $('#toggleJsonViewBtn').text('Edit JSON');
                        $('#formatJsonBtn').hide();
                        $('#expandAllBtn, #squeezeAllBtn').show();
                        isJsonView = true;

                        // Set up click events for collapsible items with animation
                        $('.collapsible').off('click').on('click', function () {
                            const $content = $(this).next('.collapsible-content');
                            const $placeholder = $(this).children('.collapsible-placeholder');

                            $(this).toggleClass('expanded').toggleClass('collapsed');
                            if ($content.is(':visible')) {
                                $content.slideUp(200); // Collapse with animation
                                $placeholder.fadeIn(200); // Show {...} with fade animation
                            } else {
                                $placeholder.fadeOut(200); // Hide {...} with fade animation
                                $content.slideDown(200); // Expand with animation
                            }
                        });
                    } catch (e) {
                        alert('Invalid JSON - Cannot toggle view');
                    }
                } else {
                    $('#json-view').remove();
                    responseElement.show();
                    $('#toggleJsonViewBtn').text('Toggle View');
                    $('#formatJsonBtn').show();
                    $('#expandAllBtn, #squeezeAllBtn').hide();
                    isJsonView = false;
                }
            });

            // Expand All functionality
            $('#expandAllBtn').on('click', function () {
                $('.collapsible-content').slideDown(200);
                $('.collapsible-placeholder').fadeOut(200);
                $('.collapsible').removeClass('collapsed').addClass('expanded');
            });

            // Squeeze All functionality
            $('#squeezeAllBtn').on('click', function () {
                $('.collapsible-content').slideUp(200);
                $('.collapsible-placeholder').fadeIn(200);
                $('.collapsible').removeClass('expanded').addClass('collapsed');
            });

            $('#formatJsonBtn').on('click', function (event) {
                event.preventDefault();
                try {
                    const json = JSON.parse($('#response').val());
                    $('#response').val(JSON.stringify(json, null, 4));
                } catch (e) {
                    alert('Invalid JSON');
                }
            });

            // Function to create collapsible JSON HTML
            function createCollapsibleJson(json) {
                if (typeof json !== 'object' || json === null) {
                    return styleJsonValue(json);
                }

                let html = '';
                const isArray = Array.isArray(json);
                html += isArray ? '[<br>' : '{<br>';
                for (const key in json) {
                    const value = json[key];
                    const isObject = typeof value === 'object' && value !== null;

                    html += `<div style="margin-left: 20px;">`;
                    if (!isArray) {
                        html += `<span class="json-key">"${key}"</span>: `;
                    }
                    if (isObject) {
                        html += `<span class="collapsible collapsed">`;
                        html += `<span class="collapsible-placeholder">{...}</span></span>`;
                        html += `<div class="collapsible-content">${createCollapsibleJson(value)}</div>`;
                    } else {
                        html += `${styleJsonValue(value)},<br>`;
                    }
                    html += '</div>';
                }
                html += isArray ? ']<br>' : '}<br>';
                return html;
            }

            // Function to style JSON values based on their type
            function styleJsonValue(value) {
                if (typeof value === 'string') {
                    const isPlaceholder = value.startsWith("{{") && value.endsWith("}}");
                    const className = isPlaceholder ? "json-placeholder" : "json-string";
                    return `<span class="${className}">"${value}"</span>`;
                } else if (typeof value === 'number') {
                    return `<span class="json-number">${value}</span>`;
                } else if (typeof value === 'boolean') {
                    return `<span class="json-boolean">${value}</span>`;
                } else if (value === null) {
                    return `<span class="json-null">null</span>`;
                }
            }

            $('#saveButton').on('click', function () {
                if (!validateForm()) return;

                $('#loading').show();
                const startTime = performance.now(); // Start time

                const formData = {
                    api_name: $('#api_name').val(),
                    response: $('#response').val(),
                    status: parseInt($('#status').val(), 10),
                    delay: parseInt($('#delay').val(), 10),
                    method: $('#method').val(),
                    timestamp: new Date().toISOString() // Adding timestamp
                };

                const id = $('#mock-id').val();
                const url = id ? `/update-mock/${id}` : '/save-mock';
                const type = id ? 'PUT' : 'POST';

                $.ajax({
                    type: type,
                    url: url,
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function () {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text(id ? 'Mock updated successfully!' : 'Mock API saved successfully!');
                        $('#processing-time').text(`Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-success').fadeIn().delay(3000).fadeOut();
                        $('#loading').hide();
                        loadMocks();
                        $('#mock-form')[0].reset();
                        $('#response-info').text("Characters: 0 | Size: 0 KB");
                        $('#mock-id').val('');
                        if (isJsonView) {
                            $('#toggleJsonViewBtn').click(); // Reset JSON view if active
                        }
                        // Keep the panel expanded after saving
                    },
                    error: function (xhr) {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Failed to save or update mock.');
                        $('#processing-time').text(`Error Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-danger').fadeIn().delay(5000).fadeOut();
                        $('#loading').hide();
                    }
                });
            });

            $('#response').on('input', function () {
                updateResponseInfo();
            });

            function loadMocks() {
                $.get('/list-mocks', function (mocks) {
                    existingMocks = mocks; // Store existing mocks for import
                    $('#mock-table').DataTable().destroy();
                    $('#mock-table-body').empty();
                    mocks.forEach(mock => addMockToTable(mock));
                    initializeDataTable();
                }).fail(function () {
                    alert('Failed to load mocks.');
                });
            }

            function addMockToTable(mock) {
                $('#mock-table-body').append(`
                    <tr data-id="${mock.id}">
                        <!-- Checkbox Cell (hidden initially) -->
                        <td class="select-checkbox" style="display: none;">
                            <input type="checkbox" class="row-checkbox">
                        </td>
                        <td><a href="/mock/${mock.api_name}" target="_blank">${mock.api_name}</a></td>
                        <td>${mock.status}</td>
                        <td>${mock.delay}</td>
                        <td>${mock.method}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>
                            <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                        </td>
                    </tr>
                `);
            }

            // Event delegation for Edit and Delete buttons
            $('#mock-table-body').on('click', '.edit-btn', function () {
                const id = $(this).closest('tr').data('id');
                editMock(id);
            });

            $('#mock-table-body').on('click', '.delete-btn', function () {
                mockIdToDelete = $(this).closest('tr').data('id');
                // Show the confirmation modal with animation
                $('#deleteConfirmationModal').modal('show');
            });

            // Handle the confirm delete button click in the modal
            $('#confirmDeleteBtn').on('click', function () {
                // Proceed with deletion
                $('#deleteConfirmationModal').modal('hide');
                $('#loading').show();
                const startTime = performance.now(); // Start time
                $.ajax({
                    type: 'DELETE',
                    url: `/delete-mock/${mockIdToDelete}`,
                    success: function () {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Mock deleted successfully.');
                        $('#processing-time').text(`Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-success').fadeIn().delay(3000).fadeOut();
                        $('#loading').hide();
                        loadMocks();
                    },
                    error: function (xhr) {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Failed to delete mock.');
                        $('#processing-time').text(`Error Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-danger').fadeIn().delay(5000).fadeOut();
                        $('#loading').hide();
                    }
                });
            });

            // Cancel button handler for Delete Modal
            $('#cancelDeleteBtn').on('click', function () {
                // Hide the modal
                $('#deleteConfirmationModal').modal('hide');
            });

            // Flush All Confirmation Modal Handlers
            $('#flushAllBtn').on('click', function () {
                $('#flushConfirmationModal').modal('show');
            });

            // Handle Flush All
            $('#confirmFlushBtn').on('click', function () {
                // Hide the confirmation modal
                $('#flushConfirmationModal').modal('hide');

                // Show loading spinner
                $('#loading').show();
                const startTime = performance.now(); // Start time

                // Send DELETE request
                $.ajax({
                    type: 'DELETE',
                    url: '/delete-all-mocks',
                    success: function () {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('All mocks have been successfully deleted.');
                        $('#processing-time').text(`Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-success').fadeIn().delay(3000).fadeOut();
                        $('#loading').hide();
                        loadMocks(); // Reload the table
                    },
                    error: function (xhr) {
                        const endTime = performance.now(); // End time
                        const duration = Math.round(endTime - startTime); // Duration in ms

                        $('#notification-message').text('Failed to delete all mocks.');
                        $('#processing-time').text(`Error Processing Time: ${duration} ms`);
                        $('#notification').removeClass('alert-success alert-warning alert-danger').addClass('alert-danger').fadeIn().delay(5000).fadeOut();
                        $('#loading').hide();
                    }
                });
            });

            $('#cancelFlushBtn').on('click', function () {
                // Hide the flush confirmation modal
                $('#flushConfirmationModal').modal('hide');
            });

            function editMock(id) {
                $('#loading').show();
                const startTime = performance.now(); // Start time
                $.get(`/get-mock/${id}`, function (mock) {
                    $('#api_name').val(mock.api_name);
                    $('#response').val(mock.response);
                    $('#status').val(mock.status);
                    $('#delay').val(mock.delay);
                    $('#method').val(mock.method);
                    $('#mock-id').val(mock.id);
                    $('#response-info').text(`Characters: ${mock.response.length} | Size: ${(new Blob([mock.response]).size / 1024).toFixed(2)} KB`);
                    const endTime = performance.now(); // End time
                    const duration = Math.round(endTime - startTime); // Duration in ms
                    $('#processing-time').text(`Processing Time: ${duration} ms`);
                    $('#loading').hide();
                    if (isJsonView) {
                        $('#toggleJsonViewBtn').click(); // Toggle back to JSON view if it's already active
                    }
                    // Expand the panel if it's collapsed
                    if (!mockFormPanel.hasClass('expanded')) {
                        expandPanel();
                    }
                }).fail(function () {
                    alert('Failed to fetch mock details.');
                    $('#loading').hide();
                });
            }

            function updateResponseInfo() {
                const length = $('#response').val().length;
                const sizeInKb = (new Blob([$('#response').val()]).size / 1024).toFixed(2);
                $('#response-info').text(`Characters: ${length} | Size: ${sizeInKb} KB`);
            }

            function validateForm() {
                let isValid = true;

                const apiName = $('#api_name').val();
                if (/\s/.test(apiName)) {
                    $('#api-name-error').show();
                    isValid = false;
                } else {
                    $('#api-name-error').hide();
                }

                const status = $('#status').val();
                if (!/^\d{3}$/.test(status)) {
                    $('#status-error').show();
                    isValid = false;
                } else {
                    $('#status-error').hide();
                }

                const delay = parseInt($('#delay').val(), 10);
                if (isNaN(delay) || delay < 0 || delay > 60000) {
                    $('#delay-error').show();
                    isValid = false;
                } else {
                    $('#delay-error').hide();
                }

                return isValid;
            }

            function initializeDataTable() {
                $('#mock-table').DataTable({
                    "order": [[1, "asc"]], // Default sorting on API Name (adjusted index due to checkbox column)
                    "columnDefs": [
                        { "orderable": false, "targets": [0, 5] }, // Disable sorting on Checkbox and Actions columns
                        { "width": "5%", "targets": 0 } // Adjust width for checkbox column
                    ],
                    "pagingType": "simple_numbers",
                    "language": {
                        "search": "_INPUT_",
                        "searchPlaceholder": "Search mocks..."
                    },
                    "autoWidth": false,
                    "responsive": true
                });
            }

            // Export Functionality
            let isExportMode = false;
            $('#exportBtn').on('click', function () {
                if (!isExportMode) {
                    enableExportMode();
                } else {
                    const selectedMocks = [];
                    $('#mock-table-body tr').each(function () {
                        const $checkbox = $(this).find('.row-checkbox');
                        if ($checkbox.is(':checked')) {
                            const id = $(this).data('id');
                            const mock = existingMocks.find(m => m.id === id);
                            if (mock) {
                                selectedMocks.push(mock);
                            }
                        }
                    });

                    if (selectedMocks.length === 0) {
                        alert('Please select at least one mock to export.');
                        return;
                    }

                    const dataStr = JSON.stringify(selectedMocks);
                    const encodedData = btoa(unescape(encodeURIComponent(dataStr)));
                    const blob = new Blob([encodedData], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mocks_backup.mock';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    disableExportMode();
                }
            });

            function enableExportMode() {
                isExportMode = true;
                $('#exportBtn').text('Download');
                $('#mock-table thead th.select-checkbox').show();
                $('#mock-table tbody td.select-checkbox').show();
                $('#select-all').prop('checked', false);
            }

            function disableExportMode() {
                isExportMode = false;
                $('#exportBtn').text('Export');
                $('#mock-table thead th.select-checkbox').hide();
                $('#mock-table tbody td.select-checkbox').hide();
                $('.row-checkbox').prop('checked', false);
            }

            // Select All functionality
            $('#select-all').on('click', function () {
                const isChecked = $(this).is(':checked');
                $('.row-checkbox').prop('checked', isChecked);
            });

            // Import Functionality
            $('#importBtn').on('click', function () {
                $('#importFileInput').click();
            });

            $('#importFileInput').on('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const decodedData = decodeURIComponent(escape(atob(e.target.result)));
                            importMocks = JSON.parse(decodedData);
                            importIndex = 0;
                            processImport();
                        } catch (error) {
                            alert('Invalid or corrupted file.');
                        }
                    };
                    reader.readAsText(file);
                }
            });

            function processImport() {
                if (importIndex >= importMocks.length) {
                    loadMocks();
                    alert('Import process completed.');
                    return;
                }
                const mock = importMocks[importIndex];
                const existingMock = existingMocks.find(m => m.api_name === mock.api_name);
                if (existingMock) {
                    $('#existingMockName').text(mock.api_name);
                    $('#overwriteConfirmationModal').modal('show');
                } else {
                    saveImportedMock(mock);
                }
            }

            $('#confirmOverwriteBtn').on('click', function () {
                const mock = importMocks[importIndex];
                saveImportedMock(mock, true);
                $('#overwriteConfirmationModal').modal('hide');
            });

            $('#cancelOverwriteBtn').on('click', function () {
                importIndex++;
                processImport();
                $('#overwriteConfirmationModal').modal('hide');
            });

            function saveImportedMock(mock, overwrite = false) {
                // Ensure timestamp is present
                if (!mock.timestamp) {
                    mock.timestamp = new Date().toISOString();
                }

                const url = overwrite ? `/update-mock/${mock.id}` : '/save-mock';
                const type = overwrite ? 'PUT' : 'POST';

                $.ajax({
                    type: type,
                    url: url,
                    contentType: 'application/json',
                    data: JSON.stringify(mock),
                    success: function () {
                        importIndex++;
                        processImport();
                    },
                    error: function (xhr) {
                        alert('Failed to import mock: ' + xhr.responseText);
                        importIndex++;
                        processImport();
                    }
                });
            }

            // Floating menu toggle
            $('#menuToggle').on('click', function () {
                $('.floating-menu').toggleClass('open');
            });

            // Flush All Functionality is handled by the confirmation modal above
        });
    </script>
</body>

</html>